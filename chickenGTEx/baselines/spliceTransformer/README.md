# SpliceTransformer ChickenGTEx Cross-Species Evaluation

## Overview

This directory contains scripts for evaluating SpliceTransformer on ChickenGTEx silver-standard benchmark data (25,000 balanced variants: 12,500 positive sQTL variants + 12,500 negative variants).

**Cross-Species Test**: SpliceTransformer was trained on human data (hg38) and is being evaluated on chicken variants (GRCg6a) to assess cross-species transferability.

---

## Directory Structure

```
spliceTransformer/
├── create_labels_file.py                  # Create labels CSV from ChickenGTEx TSV
├── evaluate_splicetransformer_results.py  # Evaluate predictions and compute metrics
├── run_splicetransformer_chicken_server.sh # Server script to run SpliceTransformer
├── README.md                              # This file
└── results/
    ├── chickengtex_labels.csv             # Ground truth labels
    ├── SpliceTransformer_chickengtex_predictions.vcf # Predictions
    └── splicetransformer_evaluation_results.json     # Metrics
```

---

## Prerequisites

### Server-Side:
1. **SpliceTransformer environment**: `/mnt/userdata4/splicing/conda_envs/sptransformer-env`
2. **SpliceTransformer code**: `/mnt/userdata4/splicing/SpliceTransformer/SpliceTransformer-master`
3. **Input VCF**: `/mnt/userdata4/splicing/SpliceAI/chicken_data/spliceai_input_chicken.vcf`
   - Generated by SpliceAI chicken pipeline
   - If missing, run: `cd /mnt/userdata4/splicing/SpliceAI/chicken_data && bash run_spliceai_chicken_pipeline.sh`

### Local:
- Python 3.8+
- pandas, numpy, scikit-learn, matplotlib, seaborn

---

## Usage

### Step 1: Create Labels File (Local)

```bash
cd /Users/byronsun/Desktop/AS_复现模型/BIB_review/code/chickenGTEx/baselines/spliceTransformer

python create_labels_file.py \
  --input_tsv /Users/byronsun/Desktop/AS_复现模型/BIB_review/data/processed_data/chickenGTEx/chickengtex_silver_benchmark_balanced.tsv \
  --output_csv chickengtex_labels.csv
```

**Output:**
- `chickengtex_labels.csv`: Contains `variant_id` and `label` columns

---

### Step 2: Run SpliceTransformer (Server)

#### Option A: Direct Server Execution

```bash
ssh yinuos@mlerp-monash-node04

cd /mnt/userdata4/splicing/SpliceTransformer

bash /path/to/run_splicetransformer_chicken_server.sh
```

#### Option B: Upload and Run

```bash
# Upload script to server
scp run_splicetransformer_chicken_server.sh \
    yinuos@mlerp-monash-node04:/mnt/userdata4/splicing/SpliceTransformer/

# SSH and run
ssh yinuos@mlerp-monash-node04
cd /mnt/userdata4/splicing/SpliceTransformer
bash run_splicetransformer_chicken_server.sh
```

**Expected Output:**
- `/mnt/userdata4/splicing/SpliceTransformer/data/SpliceTransformer_chickengtex_predictions.vcf`

**Runtime:** ~10-30 minutes for 25,000 variants

---

### Step 3: Download Results (Local)

```bash
cd /Users/byronsun/Desktop/AS_复现模型/BIB_review/code/chickenGTEx/baselines/spliceTransformer/results

scp yinuos@mlerp-monash-node04:/mnt/userdata4/splicing/SpliceTransformer/data/SpliceTransformer_chickengtex_predictions.vcf ./
```

---

### Step 4: Evaluate Results (Local)

```bash
cd /Users/byronsun/Desktop/AS_复现模型/BIB_review/code/chickenGTEx/baselines/spliceTransformer

python evaluate_splicetransformer_results.py \
  --predictions results/SpliceTransformer_chickengtex_predictions.vcf \
  --labels chickengtex_labels.csv \
  --output_dir results/
```

**Output:**
- `results/splicetransformer_evaluation_results.json`: Contains AUROC and AUPRC metrics

---

## Expected Performance

Based on rat and pig cross-species results, we expect:

| Species | Evolutionary Distance | AUROC | AUPRC | Status |
|---------|----------------------|-------|-------|--------|
| Human (hg38) | N/A (training data) | ~0.95 | ~0.95 | Excellent |
| Rat | ~90 My | 0.50 | 0.48 | Complete failure |
| Pig | ~95 My | 0.48 | 0.46 | Complete failure |
| **Chicken** | **~310 My** | **0.45-0.52** | **0.45-0.52** | **Expected failure** |

**Hypothesis**: SpliceTransformer is human-centric with limited cross-species transferability. Performance degrades to near-random or worse for non-human species, likely due to:
1. Human-specific splice site patterns
2. Lack of multi-species pre-training
3. Species-specific regulatory context differences

**Chicken Specifics**: With 310 My evolutionary divergence (greater than rat/pig), chicken represents the most challenging cross-species test. We expect:
- AUROC: 0.45-0.52 (near random or worse)
- AUPRC: 0.45-0.52
- Possible selection bias if any predictions succeed

---

## Troubleshooting

### Error: Input VCF not found

**Cause**: SpliceAI chicken VCF not generated yet

**Solution**: Run SpliceAI chicken pipeline first:
```bash
cd /Users/byronsun/Desktop/AS_复现模型/BIB_review/code/chickenGTEx/baselines/SpliceAI
bash run_spliceai_chicken_pipeline.sh
```

### Error: SpliceTransformer script not found

**Cause**: SpliceTransformer not installed on server

**Solution**: Check installation path or install SpliceTransformer:
```bash
cd /mnt/userdata4/splicing
git clone https://github.com/bioinfolabmu/SpliceTransformer.git
cd SpliceTransformer
conda create -n sptransformer-env python=3.8
conda activate sptransformer-env
pip install -r requirements.txt
```

### Error: No matching variants in evaluation

**Cause**: Variant ID format mismatch between predictions and labels

**Solution**: Check variant_id formats:
```bash
# In labels.csv
head -n 5 chickengtex_labels.csv

# In predictions VCF
grep -v "^#" results/SpliceTransformer_chickengtex_predictions.vcf | head -n 5
```

---

## Notes

1. **Cross-Species Limitation**: SpliceTransformer uses hg38 reference model, which may not generalize well to chicken genome architecture.

2. **Reference Mismatch**: The model was trained on human splice sites and regulatory contexts, which differ significantly in chicken.

3. **Expected Outcome**: Based on rat (AUROC 0.50) and pig (AUROC 0.48) results, we expect near-random or worse performance on chicken.

4. **Comparison with Other Models**:
   - DNABERT-2: AUROC 0.7757 (chicken)
   - Evo2 embedding+MLP: AUROC 0.8383 (chicken)
   - SpliceAI: AUROC 0.6004 (chicken)
   - AlphaGenome: AUROC 0.7095 (chicken)
   - **SpliceTransformer**: Expected AUROC ~0.45-0.52 (near-random)

---

## Citation

If you use this evaluation pipeline, please cite:

- **SpliceTransformer**: [Original paper citation]
- **ChickenGTEx**: This work
- **SpliceVarDB**: [Original benchmark paper]

